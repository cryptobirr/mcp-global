# Research Report: YouTube MCP Server Path Traversal Security Fix

**Spec Reference:** `.dev/issues/017-youtube-path-traversal-vulnerability/01-spec/spec.md`
**Research Date:** 2025-11-06T21:05:30Z
**Issue:** #17
**Codebase:** mcp-global (YouTube MCP Server)

---

## Executive Summary

**Project Type:** MCP Server (TypeScript/Node.js)
**Complexity:** Simple (single-file architecture)
**Brownfield/Greenfield:** Brownfield (security fix to existing code)
**Feasibility:** High

**Key Findings:**
- Critical path traversal vulnerability at `servers/binaries/youtube-mcp-server/src/index.ts:171-176`
- Existing filename sanitization pattern at lines 156-168 can be adapted for path validation
- Strong error handling patterns already in place for stream operations
- Comprehensive test infrastructure with Vitest for security test coverage
- MCP ecosystem provides reusable security validation patterns from other servers

---

## Architecture Overview

**Project Type:** Model Context Protocol (MCP) Server
**Language(s):** TypeScript, Node.js
**Framework(s):** MCP SDK v0.6.0, Vitest testing

**Directory Structure:**
- `servers/binaries/youtube-mcp-server/src/index.ts` - Main server implementation
- `servers/binaries/youtube-mcp-server/tests/streaming.test.ts` - Comprehensive test suite
- `servers/binaries/youtube-mcp-server/package.json` - Project dependencies
- `servers/binaries/youtube-mcp-server/build/` - Compiled JavaScript output

**Key Patterns:**
- Configuration: StdioServerTransport for MCP communication at index.ts:23
- Error handling: Centralized McpError with ErrorCode enums at index.ts:187-198
- File operations: Stream-based writing with automatic cleanup at index.ts:171-176
- Security: Filename sanitization with character whitelisting at index.ts:156-168

---

## Similar Patterns Found

### Pattern: Input Sanitization with Character Whitelisting
**Location:** `servers/binaries/youtube-mcp-server/src/index.ts:156-168`
**Purpose:** Sanitizes generated filenames to prevent file system injection
**Relevant because:** Spec requires similar sanitization for output_path parameter

**Code example:**
```typescript
let baseFilename = filenameWords
    ? filenameWords
        .trim()
        .toLowerCase()
        .replace(/\s+/g, '-')
        .replace(/[^a-z0-9-]/g, '')
    : `transcript-${Date.now()}`;
```

**Test coverage:** `tests/streaming.test.ts:67-89` - filename generation tests
**Dependencies:** None (vanilla JavaScript string manipulation)

### Pattern: Error Handling with Resource Cleanup
**Location:** `servers/binaries/youtube-mcp-server/src/index.ts:187-198`
**Purpose:** Handles stream errors with automatic file cleanup
**Relevant because:** Security fix needs proper error handling for rejected paths

**Code example:**
```typescript
writeStream.on('error', async (err: Error) => {
    streamError = err;
    console.error('Stream write error:', err);
    try {
        await fs.unlink(absoluteOutputPath);
        console.error(`Cleaned up partial file: ${absoluteOutputPath}`);
    } catch (unlinkErr) {
        console.error('Failed to cleanup partial file:', unlinkErr);
    }
});
```

**Test coverage:** `tests/streaming.test.ts:134-156` - stream error handling tests
**Dependencies:** fs module, Node.js streams

### Pattern: MCP Input Validation with Type Guards
**Location:** `servers/binaries/youtube-mcp-server/src/index.ts:123-130`
**Purpose:** Validates input arguments before processing
**Relevant because:** Security fix should integrate with existing validation pattern

**Code example:**
```typescript
function isValidGetTranscriptArgs(args: unknown): args is GetTranscriptArgs {
    return typeof args === 'object' && args !== null &&
        'video_url' in args && typeof (args as any).video_url === 'string' &&
        'output_path' in args && typeof (args as any).output_path === 'string';
}
```

**Test coverage:** Not explicitly tested (implementation detail)
**Dependencies:** TypeScript type system

---

## Integration Points

### System: MCP Framework (Model Context Protocol)
**Current usage:** `servers/binaries/youtube-mcp-server/src/index.ts:1-30`
**Auth pattern:** No authentication (local stdio communication)
**Error handling:** McpError with standardized error codes at index.ts:41
**Rate limiting:** Not applicable (local process communication)

**Relevant for spec requirement:** Security fix must maintain MCP protocol compliance

### System: Node.js File System Module
**Current usage:** `servers/binaries/youtube-mcp-server/src/index.ts:171-176`
**Auth pattern:** File system permissions of running process
**Error handling:** Stream-based error handling with cleanup at index.ts:187-198
**Rate limiting:** Not applicable (local file operations)

**Relevant for spec requirement:** Path validation must integrate with existing fs operations

### System: YouTube Transcript API
**Current usage:** `servers/binaries/youtube-mcp-server/src/index.ts:143` via YoutubeTranscript library
**Auth pattern:** No authentication required (public YouTube data)
**Error handling:** Library-internal error handling, wrapped in try-catch at index.ts:144-150
**Rate limiting:** Not documented (library handles YouTube API limits)

**Relevant for spec requirement:** Security fix should not affect transcript fetching

---

## Testing Infrastructure

**Framework:** Vitest with Node.js environment
**Test Location:** `servers/binaries/youtube-mcp-server/tests/streaming.test.ts`
**Conventions:** describe blocks for functionality, it blocks for specific cases

**Test Types Present:**
- Unit: Filename sanitization logic at tests/streaming.test.ts:67-89
- Integration: Stream-based file writing at tests/streaming.test.ts:90-133
- Performance: Memory usage for large datasets at tests/streaming.test.ts:200-234
- Error Scenarios: Stream error handling at tests/streaming.test.ts:134-156

**Test Infrastructure:**
- Test directory: `TEST_OUTPUT_DIR` at tests/streaming.test.ts:18
- Cleanup: Automatic directory cleanup with afterEach at tests/streaming.test.ts:235-240
- Mocking: None (real file system operations)
- Fixtures: Dynamic test data generation based on test scenarios

**CI/CD Gates:**
- All tests must pass (npm test)
- No coverage minimum specified in package.json
- Manual testing required for security validation

---

## Risks & Constraints

### Known Issues
- **CRITICAL**: Path traversal vulnerability at index.ts:171-176 allows file system escape
- No existing path validation for output_path parameter
- No audit logging for security violations (not implemented)

### Performance Constraints
- Streaming architecture handles large transcripts (60k+ entries tested)
- Memory monitoring in place at index.ts:225-233
- Path validation must not impact streaming performance significantly

### Breaking Change Risks
- Changing output_path behavior could break existing client integrations
- Backward compatibility required for legitimate use cases
- Error messages must be informative without revealing system details

### Migration Needs
- **Data migration required?** NO - no data structure changes
- **Schema changes needed?** NO - API interface remains same
- **Client migration needed?** NO - security fix should be transparent

---

## Impact Analysis & Regression Risks

**Purpose:** Identify ALL existing features that could regress when implementing security fix

### Affected Features (Regression Test Candidates)

**Feature 1: get_transcript_and_save Tool**
- **Why Affected:** Core functionality being modified for security
- **Integration Points:** servers/binaries/youtube-mcp-server/src/index.ts:152-176 - tool handler implementation
- **Regression Risk:** Legitimate file paths might be blocked by overly strict validation
- **Regression Tests Needed:**
  - Unit: Verify path validation function allows valid relative paths
  - Integration: End-to-end transcript saving with various valid path formats
  - Manual: Test with existing client integrations to ensure compatibility

**Feature 2: Filename Generation and Sanitization**
- **Why Affected:** Existing sanitization logic might be extended for path validation
- **Integration Points:** servers/binaries/youtube-mcp-server/src/index.ts:156-168 - filename generation
- **Regression Risk:** Changes to sanitization could affect generated filenames
- **Regression Tests Needed:**
  - Unit: Verify filename generation still produces valid, safe filenames
  - Integration: Complete transcript saving workflow with generated filenames
  - Manual: Review generated filenames for various video content types

**Feature 3: Error Handling and Logging**
- **Why Affected:** New security error types need integration with existing error handling
- **Integration Points:** servers/binaries/youtube-mcp-server/src/index.ts:187-198 - stream error handling
- **Regression Risk:** Security errors might not be properly caught and reported
- **Regression Tests Needed:**
  - Unit: Verify security errors trigger appropriate McpError responses
  - Integration: Test complete error flow from validation to client response
  - Manual: Verify error messages are appropriate for security violations

### Regression Test Coverage Matrix

| Feature | Unit Tests Needed | Integration Tests Needed | Manual Verification Needed |
|---------|-------------------|--------------------------|----------------------------|
| get_transcript_and_save Tool | 3 tests (path validation, error handling, edge cases) | 2 tests (valid paths, blocked paths) | Test with existing clients |
| Filename Generation | 2 tests (sanitization still works, fallback mechanisms) | 1 test (complete workflow) | Review filename formats |
| Error Handling | 2 tests (security errors, error propagation) | 1 test (error to client flow) | Verify error appropriateness |

**Total Regression Tests Required:** 11 tests
**Features Requiring Verification:** 3 features
**Coverage Target:** 100% (all affected features tested)

### Blast Radius Summary

**Direct Impact:** 1 file modified (index.ts) â†’ 3 features affected
**Indirect Impact:** 0 additional features use affected components
**Total Affected Features:** 3

**Verification Strategy:**
- ALL affected features MUST have regression tests
- Execute `/sop-regression-verification` after implementation
- Zero tolerance for test failures

---

## Blocking Decisions

### ðŸš¨ Decision Required: Path Validation Strategy

**Context:** Spec requires preventing path traversal attacks while maintaining backward compatibility. Different approaches have varying security levels and compatibility impacts.

**Options:**

#### Option A: Whitelist-Based Directory Restriction
- **Description:** Only allow output within predefined safe directories (e.g., current working directory, explicit whitelist)
- **Pros:**
  - Highest security level - explicit allowlist approach
  - Easy to understand and audit
  - Prevents all escape attempts, including future attack vectors
  - Aligns with existing filename whitelisting pattern at index.ts:156-168
- **Cons:**
  - Might break existing workflows using relative paths outside current directory
  - Requires configuration for allowed directories
  - More restrictive than necessary for some use cases
- **Complexity:** Medium
- **Implementation Impact:** New validateOutputPath() function, configuration option, error handling

#### Option B: Path Traversal Detection and Blocking
- **Description:** Detect and block specific traversal patterns (`../`, absolute paths, encoded variants) while allowing other paths
- **Pros:**
  - Maintains backward compatibility for legitimate use cases
  - Targeted fix for specific vulnerability
  - Less intrusive to existing workflows
  - Follows principle of minimum change
- **Cons:**
  - Risk of missing novel attack vectors
  - Requires continuous updates for new traversal techniques
  - More complex validation logic needed
  - Potential for bypasses through encoding variations
- **Complexity:** High
- **Implementation Impact:** Complex validation function, extensive testing for edge cases

**Recommendation:** Option A (Whitelist-Based Directory Restriction)

**Rationale:**
- Security-critical vulnerability demands maximum protection
- Existing filename sanitization already uses whitelist approach
- Configuration burden is minimal (default to current working directory)
- YouTube MCP server typically used in controlled environments
- Aligns with defense-in-depth security principles
- MCP ecosystem pattern: other servers use whitelist validation (Postgres MCP table name validation)

**If Deferred:** Security fix would be incomplete, leaving potential bypass vectors unaddressed. This decision cannot be deferred as it directly impacts the security posture of the fix.

### ðŸš¨ Decision Required: Error Message Detail Level

**Context:** Security violations need clear error messages for legitimate users without revealing system information to attackers.

**Options:**

#### Option A: Generic Security Error Messages
- **Description:** Use generic "Path validation failed" messages without revealing specific reasons
- **Pros:**
  - Maximum security - no information leakage to attackers
  - Consistent with security best practices
  - Prevents attackers from learning validation rules
  - Follows principle of least disclosure
- **Cons:**
  - Poor user experience for legitimate users
  - Difficult debugging for integration issues
  - More support requests due to unclear failures
- **Complexity:** Low
- **Implementation Impact:** Simple error message constant

#### Option B: Detailed Error Messages for Legitimate Users
- **Description:** Provide specific feedback like "Path contains invalid characters" or "Path outside allowed directory"
- **Pros:**
  - Better user experience and debugging
  - Clear guidance for legitimate users
  - Easier integration and troubleshooting
  - Follows existing error message patterns in codebase
- **Cons:**
  - Information leakage to attackers
  - Helps attackers understand validation rules
  - Potential for probing attacks
- **Complexity:** Low
- **Implementation Impact:** Multiple error message types

**Recommendation:** Option A (Generic Security Error Messages)

**Rationale:**
- Security-critical component should prioritize protection over usability
- MCP clients are typically technical users who can understand validation failures
- Consistent with security best practices for error handling
- Prevents attackers from gaining insights into validation mechanisms
- Existing error patterns in codebase are already quite generic

**If Deferred:** Could implement Option B initially with plan to migrate to Option A after user feedback, but this creates temporary security risk.

---

## Recommendations for Planning Phase

**Approach:** Brownfield security fix with minimum breaking changes

**Files to Modify:**
- `servers/binaries/youtube-mcp-server/src/index.ts:171-176` - Add path validation before file operations
- `servers/binaries/youtube-mcp-server/src/index.ts:152-168` - Extend existing validation function or create new one
- `servers/binaries/youtube-mcp-server/tests/streaming.test.ts` - Add comprehensive security test cases

**New Files Needed:**
- `servers/binaries/youtube-mcp-server/src/security.ts` - Security validation utilities (new module for separation of concerns)
- `servers/binaries/youtube-mcp-server/tests/security.test.ts` - Dedicated security test suite

**Test Strategy:**
- Unit tests: Path validation function with malicious and benign inputs
- Integration tests: Complete transcript saving workflow with path validation
- Security tests: Specific traversal attack vectors and edge cases
- Performance tests: Ensure validation doesn't impact streaming performance
- Regression tests: Verify existing functionality remains intact

**Dependencies:**
- Existing: No new dependencies needed (use Node.js path module)
- Optional: Could add `path-normalize` library for cross-platform path handling

**Open Questions for Planning:**
- [ ] Should allowed directories be configurable or hardcoded to current working directory?
- [ ] Should audit logging be implemented for blocked traversal attempts?
- [ ] What performance threshold is acceptable for path validation (should be <1ms)?

---

## References

**Key Files (with line numbers):**
- servers/binaries/youtube-mcp-server/src/index.ts:171-176 - Vulnerable path construction code
- servers/binaries/youtube-mcp-server/src/index.ts:156-168 - Existing filename sanitization pattern
- servers/binaries/youtube-mcp-server/src/index.ts:187-198 - Error handling with cleanup
- servers/binaries/youtube-mcp-server/tests/streaming.test.ts:67-89 - Filename generation tests
- servers/binaries/youtube-mcp-server/tests/streaming.test.ts:134-156 - Stream error handling tests

**External Documentation:**
- [MCP SDK Documentation](https://modelcontextprotocol.io/)
- [Node.js path Module API](https://nodejs.org/api/path.html)
- [OWASP Path Traversal Prevention](https://owasp.org/www-community/attacks/Path_Traversal)

**Security References:**
- [CWE-22: Path Traversal](https://cwe.mitre.org/data/definitions/22.html)
- [Node.js Security Best Practices](https://nodejs.org/en/docs/guides/security/)