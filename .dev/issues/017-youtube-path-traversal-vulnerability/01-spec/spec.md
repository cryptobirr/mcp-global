## üìã SPEC: YouTube MCP Server Path Traversal Security Fix

**Approach:** BROWNFIELD
**Tech Stack:** TypeScript, Node.js, Node.js fs module
**Feature Type:** BACKEND

---

### What We're Building

A critical security fix to prevent path traversal attacks in the YouTube MCP Server's output_path parameter, which currently allows attackers to write files anywhere on the filesystem outside the intended working directory.

---

### User Flow

1. **Current State**: YouTube MCP Server accepts output_path parameter without validation
2. **Security Risk**: Attackers can use `../` sequences to escape intended directories
3. **Fix Implementation**: Add path validation and sanitization before file operations
4. **Secure State**: All file writes are constrained to allowed directories only
5. **Verification**: Comprehensive security tests validate traversal protection

---

### Requirements

**Must Have:**
- Path validation function to detect and prevent traversal sequences (`../`, `..\`)
- Input sanitization to restrict output paths to allowed directories only
- Immediate failure/rejection when malicious paths are detected
- Comprehensive security test coverage for traversal attacks
- Backward compatibility for legitimate use cases
- Clear error messages for rejected paths

**Should Have:**
- Support for relative paths within allowed base directory
- Configuration option to set allowed output directories
- Audit logging of blocked path attempts
- Performance optimization to minimize path validation overhead

**Must NOT:**
- ‚ùå Allow any file writes outside designated working directories
- ‚ùå Break existing legitimate functionality
- ‚ùå Use regex alone for path validation (insufficient for security)
- ‚ùå Depend on OS-specific path handling without cross-platform validation

---

### Acceptance Criteria

**AC1:** Path Traversal Prevention
- Given: A malicious output_path containing `../` sequences like `"../../../../etc/passwd"`
- When: The get_transcript_and_save function is called with this path
- Then: The request must be rejected with a clear security error before any file operations

**AC2:** Legitimate Path Allowance
- Given: A valid output_path within the working directory like `"transcripts/video-123.txt"`
- When: The get_transcript_and_save function is called with this path
- Then: The request must proceed normally and save the file to the intended location

**AC3:** Cross-Platform Security
- Given: Traversal attempts using different path separators (`../`, `..\`, `/etc/passwd`)
- When: Path validation is performed on Windows, macOS, and Linux
- Then: All traversal attempts must be detected and blocked consistently across platforms

**AC4:** Error Handling
- Given: A path validation failure occurs
- When: The security check triggers
- Then: A descriptive error message must be returned indicating "Path traversal detected" without revealing system details

---

### Implementation Notes

**For BROWNFIELD Projects:**
- Files to modify: `servers/binaries/youtube-mcp-server/src/index.ts:171-176`
- Pattern to follow: Similar to existing filename sanitization at lines 156-168
- Integration points: get_transcript_and_save tool handler, existing error handling at lines 187-198
- Testing approach: Add security tests to `tests/streaming.test.ts`, create dedicated security test file
- Migration strategy: Immediate fix, no breaking changes to existing API

**Security Implementation Strategy:**
1. Create `validateOutputPath()` function to check for traversal sequences
2. Resolve output path against allowed base directory only
3. Validate final resolved path stays within allowed boundaries
4. Add comprehensive test cases for attack vectors
5. Ensure clear error messages for security violations

**Testing Requirements:**
- Real integration tests with actual file system operations (NO MOCKS)
- Cross-platform test coverage for different path formats
- Performance impact assessment
- Regression tests for existing functionality

---

### Open Questions

- [ ] Should we add configurable allowed directories or restrict to current working directory only?
- [ ] Do we need audit logging for blocked traversal attempts?
- [ ] What level of detail should error messages provide to users vs. attackers?

### Out of Scope

- Complete rewrite of the YouTube MCP Server (focused security fix only)
- File permission modifications beyond path validation
- Network-level security controls (this is application-layer validation)
- General input sanitization beyond output_path parameter
