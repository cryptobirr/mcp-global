#!/bin/bash

# DoD Validation Script for YouTube MCP Server Path Traversal Security Fix
# Usage: ./validate-dod.sh <plan_file> <research_file> <spec_file>

set -euo pipefail

PLAN_FILE="${1:-}"
RESEARCH_FILE="${2:-}"
SPEC_FILE="${3:-}"

if [[ -z "$PLAN_FILE" || -z "$RESEARCH_FILE" || -z "$SPEC_FILE" ]]; then
    echo "‚ùå Usage: $0 <plan_file> <research_file> <spec_file>"
    exit 1
fi

echo "üîç DoD Validation for YouTube MCP Server Path Traversal Security Fix"
echo "=================================================================="

DOD_SCORE=100
FAILURES=0

# Check 1: Plan exists and has required sections
echo "üìã Check 1: Plan structure validation"
if [[ ! -f "$PLAN_FILE" ]]; then
    echo "‚ùå Plan file not found: $PLAN_FILE"
    FAILURES=$((FAILURES + 1))
    DOD_SCORE=$((DOD_SCORE - 15))
else
    echo "‚úÖ Plan file exists"

    # Check for required sections
    REQUIRED_SECTIONS=(
        "## Summary"
        "## Architectural Decisions"
        "## Files to Modify/Create"
        "## Test Strategy"
        "### AC Coverage Map"
        "## Implementation Checklist"
        "## Definition of Done"
        "## Regression Test Strategy"
    )

    for section in "${REQUIRED_SECTIONS[@]}"; do
        if grep -q "$section" "$PLAN_FILE"; then
            echo "‚úÖ Found section: $section"
        else
            echo "‚ùå Missing section: $section"
            FAILURES=$((FAILURES + 1))
            DOD_SCORE=$((DOD_SCORE - 10))
        fi
    done
fi

# Check 2: Architectural decisions resolved
echo
echo "üèóÔ∏è  Check 2: Architectural decisions validation"
if grep -q "### AD-1:" "$PLAN_FILE" && grep -q "### AD-2:" "$PLAN_FILE"; then
    echo "‚úÖ All architectural decisions documented"
else
    echo "‚ùå Architectural decisions not properly documented"
    FAILURES=$((FAILURES + 1))
    DOD_SCORE=$((DOD_SCORE - 15))
fi

# Check 3: No unresolved blocking decisions
echo
echo "üö´ Check 3: Unresolved decision markers"
if grep -q "üö®\|DECISION REQUIRED\|TODO.*decis" "$PLAN_FILE"; then
    echo "‚ùå Found unresolved decision markers in plan"
    FAILURES=$((FAILURES + 1))
    DOD_SCORE=$((DOD_SCORE - 20))
else
    echo "‚úÖ No unresolved decision markers found"
fi

# Check 4: AC Coverage Map completeness
echo
echo "üìä Check 4: AC Coverage Map validation"
if grep -q "### AC Coverage Map" "$PLAN_FILE"; then
    # Count ACs in spec
    AC_COUNT=$(grep -c "^**AC[0-9]" "$SPEC_FILE" || echo "0")
    echo "üìà Found $AC_COUNT ACs in spec"

    # Count unique ACs in coverage map
    UNIQUE_AC_COUNT=$(grep -A 20 "### AC Coverage Map" "$PLAN_FILE" | grep "^| AC[0-9]" | cut -d'|' -f2 | sed 's/^[[:space:]]*//' | sort | uniq | wc -l | tr -d ' ')
    echo "üìä Found $UNIQUE_AC_COUNT unique ACs in coverage map"

    if [[ "$AC_COUNT" -eq "$UNIQUE_AC_COUNT" && "$AC_COUNT" -gt 0 ]]; then
        echo "‚úÖ AC Coverage Map complete ($AC_COUNT ACs)"
    else
        echo "‚ùå AC Coverage Map incomplete: $AC_COUNT ACs in spec, $UNIQUE_AC_COUNT unique in map"
        FAILURES=$((FAILURES + 1))
        DOD_SCORE=$((DOD_SCORE - 15))
    fi
else
    echo "‚ùå AC Coverage Map section missing"
    FAILURES=$((FAILURES + 1))
    DOD_SCORE=$((DOD_SCORE - 15))
fi

# Check 5: Files to modify section specificity
echo
echo "üìÅ Check 5: File modification plan specificity"
if grep -q "### File:" "$PLAN_FILE"; then
    # Check for current/target code blocks
    CURRENT_BLOCKS=$(grep -c "Current Code:" "$PLAN_FILE" || echo "0")
    TARGET_BLOCKS=$(grep -c "Target Code:" "$PLAN_FILE" || echo "0")

    if [[ "$CURRENT_BLOCKS" -gt 0 && "$TARGET_BLOCKS" -gt 0 ]]; then
        echo "‚úÖ File modification plan has current/target code blocks ($CURRENT_BLOCKS current, $TARGET_BLOCKS target)"
    else
        echo "‚ùå File modification plan missing current/target code blocks"
        FAILURES=$((FAILURES + 1))
        DOD_SCORE=$((DOD_SCORE - 10))
    fi
else
    echo "‚ùå Files to modify section missing proper File: entries"
    FAILURES=$((FAILURES + 1))
    DOD_SCORE=$((DOD_SCORE - 10))
fi

# Check 6: Implementation checklist granularity
echo
echo "‚úÖ Check 6: Implementation checklist granularity"
CHECKLIST_ITEMS=$(grep -c "\[ \]" "$PLAN_FILE" || echo "0")
if [[ "$CHECKLIST_ITEMS" -ge 15 ]]; then
    echo "‚úÖ Implementation checklist has $CHECKLIST_ITEMS items (sufficient granularity)"
elif [[ "$CHECKLIST_ITEMS" -ge 10 ]]; then
    echo "‚ö†Ô∏è  Implementation checklist has $CHECKLIST_ITEMS items (adequate)"
    DOD_SCORE=$((DOD_SCORE - 5))
else
    echo "‚ùå Implementation checklist has only $CHECKLIST_ITEMS items (insufficient)"
    FAILURES=$((FAILURES + 1))
    DOD_SCORE=$((DOD_SCORE - 10))
fi

# Check 7: Test infrastructure specification
echo
echo "üß™ Check 7: Test infrastructure specification"
if grep -q "NO MOCKS" "$PLAN_FILE"; then
    echo "‚úÖ Test infrastructure specifies NO MOCKS"
else
    echo "‚ùå Test infrastructure doesn't specify NO MOCKS approach"
    FAILURES=$((FAILURES + 1))
    DOD_SCORE=$((DOD_SCORE - 5))
fi

# Check 8: Regression Test Strategy (CRITICAL)
echo
echo "üîÑ Check 8: Regression Test Strategy completeness"
if grep -q "## Regression Test Strategy" "$PLAN_FILE"; then
    echo "‚úÖ Regression Test Strategy section exists"

    # Check for affected features from research
    AFFECTED_FEATURES=$(grep -c "#### Affected Feature" "$PLAN_FILE" || echo "0")
    if [[ "$AFFECTED_FEATURES" -ge 3 ]]; then
        echo "‚úÖ Covers $AFFECTED_FEATURES affected features"
    else
        echo "‚ùå Insufficient affected feature coverage ($AFFECTED_FEATURES features)"
        FAILURES=$((FAILURES + 1))
        DOD_SCORE=$((DOD_SCORE - 15))
    fi

    # Check for regression test execution plan
    if grep -q "### Regression Test Execution Plan" "$PLAN_FILE"; then
        echo "‚úÖ Has regression test execution plan"
    else
        echo "‚ùå Missing regression test execution plan"
        FAILURES=$((FAILURES + 1))
        DOD_SCORE=$((DOD_SCORE - 10))
    fi

    # Check for reference to /sop-regression-verification
    if grep -q "/sop-regression-verification" "$PLAN_FILE"; then
        echo "‚úÖ References /sop-regression-verification command"
    else
        echo "‚ùå Missing reference to /sop-regression-verification"
        FAILURES=$((FAILURES + 1))
        DOD_SCORE=$((DOD_SCORE - 10))
    fi
else
    echo "‚ùå Regression Test Strategy section missing"
    FAILURES=$((FAILURES + 1))
    DOD_SCORE=$((DOD_SCORE - 20))
fi

# Check 9: Timestamp and version
echo
echo "üïê Check 9: Plan metadata"
TIMESTAMP=$(grep "Created:" "$PLAN_FILE" | head -1 || echo "")
if [[ -n "$TIMESTAMP" ]]; then
    echo "‚úÖ Plan has timestamp: $TIMESTAMP"
else
    echo "‚ùå Plan missing timestamp"
    FAILURES=$((FAILURES + 1))
    DOD_SCORE=$((DOD_SCORE - 5))
fi

if grep -q "Version:" "$PLAN_FILE"; then
    echo "‚úÖ Plan has version"
else
    echo "‚ùå Plan missing version"
    FAILURES=$((FAILURES + 1))
    DOD_SCORE=$((DOD_SCORE - 5))
fi

# Final assessment
echo
echo "üìä Final DoD Assessment"
echo "========================"
echo "Total failures: $FAILURES"
echo "DoD Score: $DOD_SCORE%"

if [[ "$FAILURES" -eq 0 && "$DOD_SCORE" -ge 95 ]]; then
    echo "üéâ DoD VALIDATION PASSED"
    echo "‚úÖ Plan is ready for implementation"
    exit 0
elif [[ "$DOD_SCORE" -ge 80 ]]; then
    echo "‚ö†Ô∏è  DoD VALIDATION PASSED WITH MINOR ISSUES"
    echo "üìù Plan is acceptable but has some gaps"
    exit 0
else
    echo "‚ùå DoD VALIDATION FAILED"
    echo "üîß Plan requires revision before implementation"
    exit 1
fi