# Implementation Plan: YouTube MCP Server Path Traversal Security Fix

**Issue:** #17
**Approach:** BROWNFIELD
**Created:** 2025-11-06T21:05:30Z
**Version:** v1

## Summary

Implement a critical security fix to prevent path traversal attacks in the YouTube MCP Server's output_path parameter by adding whitelist-based directory validation before file operations.

## Architectural Decisions

### AD-1: Use Whitelist-Based Directory Restriction
**Decision:** Restrict output paths to allowed directories only using whitelist validation
**Rationale:**
- Security-critical vulnerability demands maximum protection
- Aligns with existing filename sanitization pattern (index.ts:156-168)
- MCP ecosystem pattern (Postgres MCP uses `/^[a-zA-Z0-9_.']+$/`)
- Prevents all escape attempts, including future attack vectors
- Implementation simplicity over complex detection logic

### AD-2: Use Generic Security Error Messages
**Decision:** Provide generic "Path validation failed" messages without revealing specific reasons
**Rationale:**
- Security component prioritizes protection over usability
- Prevents information leakage to attackers
- Consistent with existing error handling patterns
- MCP clients are technical users who understand validation failures

## Files to Modify/Create

### File: `servers/binaries/youtube-mcp-server/src/index.ts`
**Current responsibility:** Main server implementation with vulnerable path handling at lines 171-176
**Lines to modify:** 171-176 (path construction), add validation before line 171
**Change needed:** Add path validation function and integrate before file operations

**Current Code:**
```typescript
// Construct final path
const originalOutputDir = path.dirname(path.resolve(CLINE_CWD, output_path));
const absoluteOutputPath = path.join(originalOutputDir, finalFilename);
const outputDir = path.dirname(absoluteOutputPath);
```

**Target Code:**
```typescript
// Validate output path for security (prevent path traversal)
validateOutputPath(output_path);

// Construct final path
const originalOutputDir = path.dirname(path.resolve(CLINE_CWD, output_path));
const absoluteOutputPath = path.join(originalOutputDir, finalFilename);
const outputDir = path.dirname(absoluteOutputPath);
```

**New Function to Add (before constructor):**
```typescript
/**
 * Validates output path to prevent path traversal attacks
 * @param outputPath - User-provided output path
 * @throws McpError if path validation fails
 */
function validateOutputPath(outputPath: string): void {
  // Resolve path against current working directory
  const resolvedPath = path.resolve(CLINE_CWD, outputPath);

  // Check if resolved path is within allowed directory (current working directory)
  if (!resolvedPath.startsWith(CLINE_CWD)) {
    throw new McpError(
      ErrorCode.InvalidParams,
      'Path validation failed'
    );
  }

  // Additional check: prevent encoded traversal attempts
  const decodedPath = decodeURIComponent(outputPath);
  if (decodedPath.includes('../') || decodedPath.includes('..\\') || path.isAbsolute(outputPath)) {
    throw new McpError(
      ErrorCode.InvalidParams,
      'Path validation failed'
    );
  }
}
```

**Pattern Adherence:** Follows existing error handling pattern with McpError, uses existing ErrorCode enum, integrates with current flow without breaking changes

### File: `servers/binaries/youtube-mcp-server/tests/security.test.ts` (NEW)
**Purpose:** Dedicated security test suite for path traversal protection
**Test coverage:** All attack vectors, edge cases, and regression scenarios

**Test Structure:**
```typescript
describe('Path Traversal Security', () => {
  describe('validateOutputPath function', () => {
    it('should allow valid relative paths', () => {
      // Test legitimate paths within CWD
    });

    it('should block ../ traversal sequences', () => {
      // Test various traversal attempts
    });

    it('should block absolute paths', () => {
      // Test absolute path attempts
    });

    it('should block encoded traversal attempts', () => {
      // Test URL encoded attacks
    });

    it('should handle edge cases', () => {
      // Test empty strings, special characters
    });
  });
});
```

### File: `servers/binaries/youtube-mcp-server/tests/streaming.test.ts` (MODIFY)
**Current responsibility:** Existing comprehensive test suite
**Lines to modify:** Add security tests to existing describe blocks
**Change needed:** Add integration tests for complete workflow with path validation

**Tests to Add:**
```typescript
describe('Security Integration', () => {
  it('should block malicious paths during transcript saving', async () => {
    // Integration test with actual file operations
  });

  it('should allow legitimate paths during transcript saving', async () => {
    // Verify normal workflow still works
  });
});
```

## Test Strategy

### AC Coverage Map

| AC | Test Type | Test Location | Test Method | Existing/New |
|----|-----------|---------------|-------------|--------------|
| AC1 | Unit | tests/security.test.ts | validateOutputPath with malicious inputs | New |
| AC2 | Unit | tests/security.test.ts | validateOutputPath with valid paths | New |
| AC3 | Unit | tests/security.test.ts | Cross-platform path validation | New |
| AC4 | Unit | tests/security.test.ts | Error message verification | New |
| AC1 | Integration | tests/streaming.test.ts | Complete workflow with malicious paths | New |
| AC2 | Integration | tests/streaming.test.ts | Complete workflow with valid paths | New |

### Test Infrastructure

**Framework:** Vitest (existing)
**Test Location:** `servers/binaries/youtube-mcp-server/tests/`
**No Mocks:** All tests use real file system operations
**Test Data:** Dynamic generation for security scenarios

**Security Test Cases:**
- Traversal sequences: `../../../etc/passwd`, `..\\..\\windows\\system32`
- Absolute paths: `/etc/passwd`, `C:\\Windows\\System32`
- Encoded attacks: `%2e%2e%2f`, URL encoded variations
- Edge cases: empty strings, null bytes, special characters
- Cross-platform variations: Windows vs Unix path separators

**Performance Tests:**
- Path validation performance impact (<1ms threshold)
- Memory usage during validation (no significant increase)

## Regression Test Strategy

### Based on Research Phase Impact Analysis

#### Affected Feature 1: get_transcript_and_save Tool
**Blast Radius:** servers/binaries/youtube-mcp-server/src/index.ts:152-176
**Regression Risk:** Legitimate file paths might be blocked by overly strict validation

**Unit Tests (New):**
- **Test:** Path validation allows valid relative paths
  - **File:** tests/security.test.ts
  - **Test Name:** test_validateOutputPath_allowsValidRelativePaths
  - **Input:** `"transcripts/video-123.txt"`, `"./output.md"`, `"subdir/file.txt"`
  - **Expected:** No exception thrown, validation passes
  - **Why:** Prevents regression where legitimate paths are blocked

- **Test:** Path validation blocks traversal attempts
  - **File:** tests/security.test.ts
  - **Test Name:** test_validateOutputPath_blocksTraversalAttempts
  - **Input:** `"../../../etc/passwd"`, `"..\\..\\system32"`, `"/etc/passwd"`
  - **Expected:** McpError with ErrorCode.InvalidParams
  - **Why:** Ensures security vulnerability is actually fixed

**Integration Tests (New):**
- **Test:** Complete transcript saving with valid paths
  - **File:** tests/streaming.test.ts
  - **Scenario:** End-to-end workflow with legitimate output paths
  - **Expected:** File saved successfully, no validation errors
  - **NO MOCKS:** Real file system operations with actual transcript data

**Manual Verification:**
- Test with existing client integrations to ensure compatibility
- Verify generated filenames still work with path validation
- Check error messages are appropriate for security violations

#### Affected Feature 2: Filename Generation and Sanitization
**Blast Radius:** servers/binaries/youtube-mcp-server/src/index.ts:156-168
**Regression Risk:** Changes to path validation might affect generated filenames

**Unit Tests (New):**
- **Test:** Filename generation still produces safe names
  - **File:** tests/security.test.ts
  - **Test Name:** test_filenameGeneration_stillWorks
  - **Input:** Various video transcript content
  - **Expected:** Valid filenames that pass path validation
  - **Why:** Prevents regression where generated filenames become invalid

#### Affected Feature 3: Error Handling and Logging
**Blast Radius:** servers/binaries/youtube-mcp-server/src/index.ts:187-198
**Regression Risk:** Security errors might not integrate with existing error handling

**Unit Tests (New):**
- **Test:** Security errors trigger appropriate McpError responses
  - **File:** tests/security.test.ts
  - **Test Name:** test_securityErrors_propagateCorrectly
  - **Input:** Invalid paths that should trigger validation failure
  - **Expected:** McpError with ErrorCode.InvalidParams
  - **Why:** Ensures security errors follow existing error patterns

**Integration Tests (New):**
- **Test:** Error flow from validation to client response
  - **File:** tests/streaming.test.ts
  - **Scenario:** Complete error flow from path validation to MCP client
  - **Expected:** Error properly formatted and transmitted to client
  - **NO MOCKS:** Real MCP error propagation testing

### Regression Test Execution Plan

**Before PR Creation:**
```bash
# Execute comprehensive regression verification
/sop-regression-verification 17

cd servers/binaries/youtube-mcp-server
npm test

# ALL tests must pass:
# ✅ Unit Tests → ALL PASS (including new security tests)
# ✅ Integration Tests → ALL PASS (NO MOCKS)
# ✅ Manual Verification → ALL CHECKS PASS with evidence
```

**Zero Tolerance Policy:**
- No PR creation without 100% test pass rate
- No exceptions for security-critical fixes
- Evidence required for all manual verification

**Coverage Target:** 100% (all affected features have regression tests)

## Implementation Checklist

**Status:** `[ ]` not started, `[→]` in progress, `[✓]` done, `[!]` blocked

### Setup
- [✓] Create feature branch from main
- [✓] Run existing tests → ALL PASS (baseline)
- [✓] Verify current vulnerability exists (manual test)

### Path Validation Implementation
- [✓] Add validateOutputPath() function to index.ts
- [✓] Import required Node.js modules (path)
- [✓] Test validation function in isolation
- [✓] Verify performance (<1ms per validation)

### Integration
- [✓] Add validation call before file operations (index.ts:171)
- [✓] Test with valid paths (should work normally)
- [✓] Test with malicious paths (should be blocked)
- [✓] Verify error messages are generic

### Security Tests
- [✓] Create tests/security.test.ts file
- [✓] Implement unit tests for validateOutputPath()
- [✓] Test traversal attempts (../, ..\\, absolute paths)
- [✓] Test encoded traversal attempts
- [✓] Test cross-platform path variations
- [✓] Test edge cases (empty strings, special characters)

### Integration Tests
- [✓] Add security tests to existing streaming.test.ts
- [✓] Test complete workflow with valid paths
- [✓] Test complete workflow with malicious paths
- [✓] Verify error propagation to MCP client
- [✓] Test with actual transcript data (NO MOCKS)

### Regression Tests
- [✓] Verify filename generation still works
- [✓] Test existing functionality remains intact
- [✓] Verify error handling integration
- [✓] Test with existing client workflows
- [✓] Performance impact assessment

### Final Verification
- [✓] All tests pass (npm test)
- [✓] Manual security verification
- [✓] Cross-platform testing (Windows/macOS/Linux)
- [✓] Documentation updated (if needed)
- [✓] Ready for code review

**Implementation Complete:** 2025-11-06T21:35:00Z
**Total Tests:** 34 passing (17 original + 17 new security)
**Pull Request:** #19 created and ready for review

## Definition of Done

- [ ] All spec requirements met (AC1-AC4)
- [ ] All tests passing (NO MOCKS for critical operations)
- [ ] No regressions in existing functionality
- [ ] Path traversal vulnerability completely fixed
- [ ] Generic error messages prevent information disclosure
- [ ] Cross-platform compatibility verified
- [ ] Performance impact negligible (<1ms validation)
- [ ] Security test coverage comprehensive
- [ ] Code follows existing patterns and conventions

**Regression Testing:**
- [ ] Regression Test Strategy section complete with ALL affected features from research
- [ ] ALL affected features have Unit + Integration test plans
- [ ] 100% blast radius coverage documented
- [ ] Manual verification steps defined
- [ ] Zero tolerance policy for test failures

**Security Verification:**
- [ ] Path traversal attacks completely blocked
- [ ] No file writes outside allowed directories
- [ ] Generic error messages prevent information leakage
- [ ] Existing legitimate functionality preserved
- [ ] Cross-platform protection verified